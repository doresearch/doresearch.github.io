<!DOCTYPE html>

<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<title>Canvas梦幻大树生长动画特效</title>
	<script type="text/javascript" src="https://libs.baidu.com/jquery/2.0.0/jquery.min.js"></script>
	<script type="text/javascript">
		(function ($) {
			/**
				x,y坐标
			*/
			var Vector = function (x, y) {
				this.x = x || 0;
				this.y = y || 0;
			};

			Vector.prototype = {
				//矢量相加
				add(v) {
					this.x += v.x;
					this.y += v.y;
					return this;
				},
				//矢量的长度
				length() {
					return Math.sqrt(this.x * this.x + this.y * this.y);
				},
				//矢量角度
				rotate(theta) {
					var x = this.x;
					var y = this.y;
					this.x = Math.cos(theta) * this.x - Math.sin(theta) * this.y;
					this.y = Math.sin(theta) * this.x + Math.cos(theta) * this.y;
					return this;
				},
				//混合矢量？
				mult(f) {
					this.x *= f;
					this.y *= f;
					return this;
				}
			};
			/**
			p:矢量位置
			r:半径
			c:颜色
			t:树的父对象
			*/
			let Leaf = function (p, r, c, t) {
				this.p = p || null;
				this.r = r || 0;
				this.tree = t;
				this.color = c || 'rgba(255,255,255,1.0)';
				// this.register();
			}

			Leaf.prototype = {
				render() {
					this.draw();
				},
				draw() {
					let ctx = this.tree.ctx;
					ctx.beginPath();
					ctx.fillStyle = this.color;
					ctx.moveTo(this.p.x, this.p.y);
					ctx.arc(this.p.x, this.p.y, Branch.random(this.r * 0.5, this.r), 0, Branch.circle, true);
					ctx.fill();
				}
			}
			/**
			p:矢量位置
			v:矢量速度
			r:半径
			c:颜色
			t:树的父对象
			*/
			let Branch = function (p, v, r, c, t) {
				this.p = p || null;
				this.v = v || null;
				this.r = r || 0;
				this.length = 0;
				this.generation = 1;
				this.tree = t || null;
				this.color = c || 'rgba(255,255,255,1.0)';
				this.register();
			}
			/**
			register:产生分叉
			draw:绘制
			grow:成长
			*/
			Branch.prototype = {
				register() {
					this.tree.addBranch(this);
				},
				draw() {
					let ctx = this.tree.ctx;
					ctx.beginPath();
					ctx.fillStyle = this.color;
					ctx.arc(this.p.x, this.p.y, this.r, 0, Branch.circle, true);
					ctx.fill();
				},
				grow() {
					this.draw();
					this.modify();
					this.fork();
				},
				modify() {
					let angle = 0.18 - (0.10 / this.generation);
					// let angle = 0;
					this.p.add(this.v);
					this.length += this.v.length();
					this.r *= 0.99;
					this.v.rotate(Branch.random(-angle, angle)); //.mult(0.996);
					if (this.r < 0.8 || this.generation > 10) {
						this.tree.removeBranch(this);
						let l = new Leaf(this.p, 10, this.color, this.tree);
						l.render();
					}
				},
				fork() {
					let p = this.length - Branch.random(100, 200); // + (this.generation * 10);

					if (p > 0) {
						var n = Math.round(Branch.random(1, 3));
						this.tree.start.fork += n - 1;
						for (var i = 0; i < n; i++) {
							Branch.clone(this);
						}
						this.tree.removeBranch(this);
					}
				}
			}
			//Command method
			Branch.circle = 2 * Math.PI;
			Branch.rgba = function (r, g, b, a) {
				return 'rgba(' + r + ',' + g + ',' + b + ',' + a + ')';
			};

			Branch.randomrgba = function (min, max, a) {
				return Branch.rgba(Math.round(Branch.random(min, max)), Math.round(Branch.random(min, max)), Math.round(Branch.random(min, max)), a);
			};

			Branch.random = function (min, max) {
				return Math.random() * (max - min) + min;
			};

			Branch.clone = function (b) {
				var r = new Branch(new Vector(b.p.x, b.p.y), new Vector(b.v.x, b.v.y), b.r, b.color, b.tree);
				r.generation = b.generation + 1;
				return r;
			};
			/**
				绘制树状态，使用branch存储当前树分支，
				使用timer来计时,
				addBranch添加分支，removeBranch删除分支，render输出画面
				init初始化，abord取消
			*/
			let Tree = function () {
				let branches = [], timer;
				this.start = {
					fork: 0,
					length: 0
				}

				this.addBranch = b => branches.push(b);

				this.removeBranch = function (b) {
					for (var i = 0; i < branches.length; i++) {
						if (branches[i] === b) {
							branches.splice(i, 1);
							return;
						}
					};
				}

				this.render = function (cb) {
					var that = this;
					timer = setInterval(function () {
						cb.apply(that, this);

						if (branches.length > 0) {
							for (var i = 0; i < branches.length; i++) {
								branches[i].grow();
							}
						}
						else {
							clearInterval(timer);
						}
					}, 1000 / 30);
				}

				this.init = ctx => this.ctx = ctx;

				this.abort = function () {
					branches = [];
					this.stat = {
						fork: 0,
						length: 0
					}
				};
			}
			/**
				stretch_factor 600 / canvas_height
				y_speed 2 / stretch_factor
			*/
			function init() {
				//先绘制一条直线
				let $window = $(window),
					canvas = $('#canvas')[0],
					ctx = canvas.getContext('2d'),

					canvas_width = $window.width(),
					canvas_height = $window.height(),
					center_x = canvas_width / 2,

					$statMsg = $("#statMsg"),
					stretch_factor = 600 / canvas_height,
					y_speed = 2 / stretch_factor;

				canvas.width = canvas_width;
				canvas.height = canvas_height;
				ctx.globalCompositeOperation = "lighter";

				let t = new Tree();
				t.init(ctx);

				for (var i = 0; i < 3; i++) {
					new Branch(
						new Vector(center_x, canvas_height),
						new Vector(Math.random(-1, 1), -y_speed),
						15 / stretch_factor,
						Branch.randomrgba(0, 255, 0.3),
						t);
					// 绘制3个分支
					// new Branch();
				}

				t.render(function () {
					$statMsg.html(this.start.fork);
				});
			}

			$(function () {
				init();
			})
		})(jQuery)
	</script>

	<style type="text/css">
		body {
			padding: 0;
			margin: 0;
			overflow: hidden;
			background: #fff;
			font-family: Courier;
		}

		canvas {
			background-color: #000;
			cursor: pointer;
		}
	</style>
</head>

<body>
	<canvas id="canvas" width="1440" height="900"></canvas>
	<div id="statMsg" style="display:none;">192</div>
	<div style="text-align:center;margin:1px 0; font:normal 14px/24px;color:#000;">
	</div>
</body>

</html>